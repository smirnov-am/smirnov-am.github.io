<!DOCTYPE html>
<html âš¡>
<head>
    <meta charset="utf-8">

    <title>Basic Financial Calculations with Python and Pandas</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="canonical" href="http://smirnov-am.github.io/basic-financial-calculations-with-python-and-pandas/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="smirnov-am.github.io" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Basic Financial Calculations with Python and Pandas" />
    <meta property="og:description" content="In this post I&#x27;ll cover:

 * Net present value (NPV)
 * Internal rate of return (IRR)
 * Payment schedules and loan tables
 * Future value
 * Pension and accumulation problems
 * Continuously compounded interest

Net present value
Present value allows to answer a simple question &quot;should I put my money in a
bank or invest&quot;. Let&#x27;s say I have $100 and the bank gives a 12% annual interest
rate. Alternatively, I can lend this money to a friend and he promises to pay
$10 for 12 months. The moral aspec" />
    <meta property="og:url" content="http://smirnov-am.github.io/basic-financial-calculations-with-python-and-pandas/" />
    <meta property="og:image" content="http://smirnov-am.github.io/content/images/2019/04/pyfinmod1.png" />
    <meta property="article:published_time" content="2018-12-24T19:48:00.000Z" />
    <meta property="article:modified_time" content="2019-04-29T18:30:23.000Z" />
    <meta property="article:tag" content="Financial Modelling" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Basic Financial Calculations with Python and Pandas" />
    <meta name="twitter:description" content="In this post I&#x27;ll cover:

 * Net present value (NPV)
 * Internal rate of return (IRR)
 * Payment schedules and loan tables
 * Future value
 * Pension and accumulation problems
 * Continuously compounded interest

Net present value
Present value allows to answer a simple question &quot;should I put my money in a
bank or invest&quot;. Let&#x27;s say I have $100 and the bank gives a 12% annual interest
rate. Alternatively, I can lend this money to a friend and he promises to pay
$10 for 12 months. The moral aspec" />
    <meta name="twitter:url" content="http://smirnov-am.github.io/basic-financial-calculations-with-python-and-pandas/" />
    <meta name="twitter:image" content="http://smirnov-am.github.io/content/images/2019/04/pyfinmod1.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Alexey Smirnov" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Financial Modelling" />
    <meta property="og:image:width" content="2047" />
    <meta property="og:image:height" content="2012" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "smirnov-am.github.io",
        "logo": {
            "@type": "ImageObject",
            "url": "http://smirnov-am.github.io/favicon.ico",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Alexey Smirnov",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/f3f61e69a3bdf7419f19cb1be356c0b1?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://smirnov-am.github.io/author/alexey/",
        "sameAs": []
    },
    "headline": "Basic Financial Calculations with Python and Pandas",
    "url": "http://smirnov-am.github.io/basic-financial-calculations-with-python-and-pandas/",
    "datePublished": "2018-12-24T19:48:00.000Z",
    "dateModified": "2019-04-29T18:30:23.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "http://smirnov-am.github.io/content/images/2019/04/pyfinmod1.png",
        "width": 2047,
        "height": 2012
    },
    "keywords": "Financial Modelling",
    "description": "In this post I&#x27;ll cover:\n\n * Net present value (NPV)\n * Internal rate of return (IRR)\n * Payment schedules and loan tables\n * Future value\n * Pension and accumulation problems\n * Continuously compounded interest\n\nNet present value\nPresent value allows to answer a simple question &quot;should I put my money in a\nbank or invest&quot;. Let&#x27;s say I have $100 and the bank gives a 12% annual interest\nrate. Alternatively, I can lend this money to a friend and he promises to pay\n$10 for 12 months. The moral aspec",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://smirnov-am.github.io/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.21" />
    <link rel="alternate" type="application/rss+xml" title="smirnov-am.github.io" href="http://smirnov-am.github.io/rss/" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="http://smirnov-am.github.io">smirnov-am.github.io</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Basic Financial Calculations with Python and Pandas</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/alexey/">Alexey Smirnov</a></p>
                    <time class="post-date" datetime="2018-12-24">2018-12-24</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="http://smirnov-am.github.io/content/images/2019/04/pyfinmod1.png" width="600" height="400" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <p>In this post I'll cover:</p><ul><li>Net present value (NPV)</li><li>Internal rate of return (IRR)</li><li>Payment schedules and loan tables</li><li>Future value</li><li>Pension and accumulation problems</li><li>Continuously compounded interest</li></ul><h2 id="net-present-value">Net present value</h2><p>Present value allows to answer a simple question "should I put my money in a bank or invest". Let's say I have $100 and the bank gives a 12% annual interest rate. Alternatively, I can lend this money to a friend and he promises to pay $10 for 12 months. The moral aspect aside NPV gives an answer which alternative is more profitable.</p><p>The second alternative can be described as a series of cash flows:</p><ul><li>-$100 at month=0</li><li>+$10 at month=1</li><li>...</li><li>+$10 at month=12</li></ul><p>At each period value should be adjusted by the interest rate (also called the discount rate) using formula</p><figure class="kg-card kg-image-card"></figure><p>This basic concept shows that $100 now is not the same as $100 promised in a year. $100 now is $110 in a year.</p><p>To calculate the discounted value I'll convert annual discount (interest) rate to daily and use the number of days elapsed as <em>t</em>. The function accepts a dataframe with a date column and a cash flow column.</p><pre><code>def npv(dataframe, 
        annual_discount_rate, 
        cash_flow_column_name='cash flow', 
        date_column_name='date'):
    date_start = dataframe[date_column_name].min()
    mapper = lambda x: _calculate_discounted(x[cash_flow_column_name], 
                                             annual_discount_rate, 
                                             (x[date_column_name] - date_start).days)
    return dataframe[[cash_flow_column_name, date_column_name]].apply(mapper, axis=1).sum()

def _calculate_discounted(cf, annual_interest_rate, days_passed):
    daily_interest_rate = convert_ir(annual_interest_rate, from_period='year', to_period='day')
    return cf / (1 + daily_interest_rate)**days_passed
</code></pre><p>Let's calculate NPV of lending to a friend:</p><pre><code>&gt;&gt;&gt; import pandas as pd
&gt;&gt;&gt; from datetime import date, timedelta
&gt;&gt;&gt; from dateutil.relativedelta import relativedelta
&gt;&gt;&gt; dates = [date.today() + relativedelta(months=i) for i in range(13)]
&gt;&gt;&gt; df = pd.DataFrame(data={'cash flow': [-100] + [10]*12, 
                            'date': dates})
&gt;&gt;&gt; npv(df, 0.1)
14.011086147172053
</code></pre><p>The calculated NPV of lending alternative is ~$14 which means that it is profitable. This value represents your wealth increment. Â Companies use NPV<br />to calculate if it's, for example, viable to invest in a factory that will generate cash flows in the future or it's better to put the money elsewhere.</p><p><code>npv</code> function can also operate with time-dated cash flows - that is when the cash flows are not evenly placed.</p><h2 id="internal-rate-of-returns">Internal rate of returns</h2><p>So I decided to lend to a friend. What is the effective interest rate for this alternative? Internal rate of returns (IRR) answers that. The solution of the following equation for <em>r</em> gives IRR:</p><figure class="kg-card kg-image-card"></figure><p>Effectively we are finding interest rate when NPV is 0.</p><p>The function will accept the same dataframe as an input. I'm using scipy numerical <a href="https://docs.scipy.org/doc/scipy-0.13.0/reference/generated/scipy.optimize.fsolve.html">solver</a> to find <em>r</em>. The solver accepts the initial <em>guess</em> argument which helps to find the solution.</p><pre><code>def irr(dataframe, guess=0, cash_flow_column_name='cash flow', date_column_name='date'):
    f = partial(npv, dataframe, cash_flow_column_name=cash_flow_column_name)
    result = fsolve(f, guess)
    return list(result)
</code></pre><pre><code>&gt;&gt;&gt; irr(df, 0.0)
[0.41354120272404077]
</code></pre><p>Lending to a friend has an effective interest rate of 41%</p><p>Sometimes a series of cash flows can have more than one IRR. We can play with <em>guess</em> to find both solutions.</p><pre><code>&gt;&gt;&gt; dates = [date.today() + relativedelta(years=i) for i in range(6)]
&gt;&gt;&gt; df3 = pd.DataFrame(data={'cash flow': [-145, 100, 100, 100, 100, -275],                              'date': dates})
&gt;&gt;&gt; irr(df3, 0.1), irr(df3, 0.4)
([0.08793680470699422], [0.26585705483081506])
</code></pre><h2 id="flat-payment-schedules">Flat payment schedules</h2><p>Let's look at the lending problems from the friend's point of view. He knows that with the cash flow he proposed he will be paying 41% annual interest rate. He wants to lower the interest rate to say 30% and calculates a new flat payment scheme. Flat here means that he will pay a constant amount each month for a <em>term</em> amount of months.</p><p>First, let's calculate the monthly payment. Function argument will be</p><ul><li><em>principal</em> - the lending amount</li><li><em>annual_interest_rate</em> - agreed interest rate in a term of a year</li><li><em>term</em> - how many terms to pay</li><li><em>period</em> - unit of a <em>term</em></li></ul><pre><code>def pmt(principal, annual_interest_rate, term, period='year'):
    periodic_interest = convert_ir(annual_interest_rate, from_period='year', to_period=period)
    payment = (principal*periodic_interest)/(1 - (1 + periodic_interest)**(-term))
    return payment
</code></pre><pre><code>&gt;&gt;&gt; pmt(100, 0.3, 12, period='month')
9.57859525723352
</code></pre><p>So he will be paying ~$9.6 each month. Now he wants to know how fast he's re-paying the interest and the principal. For that, a loan table is used.</p><pre><code>def flat_payments(principal, annual_interest_rate, term, period='year'):
    _pmt = pmt(principal, annual_interest_rate, term, period=period)
    data = defaultdict(list)
    current_principal = principal
    principal_col_name = 'principal at the beginning of {}'.format(period)
    payment_col_name = 'payment at the end of {}'.format(period)
    interest_col_name = 'interest'
    return_principal_col_name = 'return of principal'
    periodic_interest = convert_ir(annual_interest_rate, from_period='year', to_period=period)
    for _t in range(1, term + 1):
        data[period].append(_t)
        data[principal_col_name].append(current_principal)
        data[payment_col_name] = _pmt
        current_interest = current_principal * periodic_interest
        data[interest_col_name].append(current_interest)
        current_return_of_principal = _pmt - current_interest
        data[return_principal_col_name].append(current_return_of_principal)
        current_principal -= current_return_of_principal  
    assert round(current_principal) == 0
    return pd.DataFrame.from_dict(data)
</code></pre><pre><code>&gt;&gt;&gt; res_df = flat_payments(100, 0.3, 12, period='month')
&gt;&gt;&gt; print(tabulate(res_df, tablefmt="pipe", headers="keys"))
</code></pre><table>
<thead>
<tr>
<th></th>
<th>month</th>
<th>principal at the beginning of month</th>
<th>payment at the end of month</th>
<th>interest</th>
<th>return of principal</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>100</td>
<td>9.5786</td>
<td>2.21045</td>
<td>7.36815</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>92.6318</td>
<td>9.5786</td>
<td>2.04758</td>
<td>7.53102</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>85.1008</td>
<td>9.5786</td>
<td>1.88111</td>
<td>7.69749</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>77.4033</td>
<td>9.5786</td>
<td>1.71096</td>
<td>7.86764</td>
</tr>
<tr>
<td>4</td>
<td>5</td>
<td>69.5357</td>
<td>9.5786</td>
<td>1.53705</td>
<td>8.04155</td>
</tr>
<tr>
<td>5</td>
<td>6</td>
<td>61.4942</td>
<td>9.5786</td>
<td>1.35929</td>
<td>8.2193</td>
</tr>
<tr>
<td>6</td>
<td>7</td>
<td>53.2749</td>
<td>9.5786</td>
<td>1.17761</td>
<td>8.40098</td>
</tr>
<tr>
<td>7</td>
<td>8</td>
<td>44.8739</td>
<td>9.5786</td>
<td>0.991912</td>
<td>8.58668</td>
</tr>
<tr>
<td>8</td>
<td>9</td>
<td>36.2872</td>
<td>9.5786</td>
<td>0.802108</td>
<td>8.77649</td>
</tr>
<tr>
<td>9</td>
<td>10</td>
<td>27.5107</td>
<td>9.5786</td>
<td>0.608109</td>
<td>8.97049</td>
</tr>
<tr>
<td>10</td>
<td>11</td>
<td>18.5402</td>
<td>9.5786</td>
<td>0.409821</td>
<td>9.16877</td>
</tr>
<tr>
<td>11</td>
<td>12</td>
<td>9.37144</td>
<td>9.5786</td>
<td>0.207151</td>
<td>9.37144</td>
</tr>
</tbody>
</table>
<p>I'm using <a href="https://pypi.org/project/tabulate/">tabulate</a> to print dataframes in the terminal.</p><p>The last two columns - <em>interest</em> and <em>return of principal</em> - show how the payment is split between repaying interest and principal. At the end, principal value should be 0 (see assert in function code). It's interesting to know how much interest is re-payed because that amount sometimes is tax deductible.</p><h2 id="future-value">Future value</h2><p>Letâ€™s imagine we put $10000 today for 10 years with an annual interest rate 10%. How much money we will have in 10 years? Using this formula with r=0.1 ant t=10 will give us $2593.74:</p><figure class="kg-card kg-image-card"></figure><p>A slightly more complex problem is if we want to deposit some money during these 10 years. The f<em>uture value</em> will tell how much money we'll have in the end of the period.</p><p>The function accepts a list of deposit amounts and, annual interest rate and a period at which deposits are made</p><pre><code>def fv(deposits, annual_interest_rate, period='year'):
    periodic_interest = convert_ir(annual_interest_rate, from_period='year', to_period=period)
    future_value = 0
    number_of_deposits = len(deposits)
    for n, deposit in enumerate(deposits):
        future_value += deposit * (1 + periodic_interest)**(number_of_deposits - n)
    return future_value
</code></pre><pre><code>&gt;&gt;&gt; fv([1000 for _ in range(10)], 0.1, period='year')
17531.16706110001
</code></pre><p>So depositing $1000 for 10 years will yield $17.5k given the interest rate is 10%.</p><h2 id="retirement-problem">Retirement problem</h2><p>Consider the following exercise. Now I'm 31 and planning to retire at 55 (24 more years working). After retiring I'm planning to live at least 25 more years and will need, say, $50000 a year. To support my retirement I need to deposit money into a bank account with known interest rate (say 5%). What's the minimum amount do I need to deposit each year?</p><p>This problem implies a number of cash flows: 24 terms with CF=<em>x</em> at each time, and 25 terms with CF=-50000. The present value of this cash flows should be 0. Solving this equation for <em>x</em> will give the minimum annual deposit. The minimum deposit is used here not in a mathematical sense, but more in common sense - I'll live more that 25 years after retirement, prices are also going up so I'll need more than 50k yearly.</p><pre><code>def get_retirement_cf_dataframe(deposit, terms_of_deposit, withdrawal, terms_of_withdrawal, period='year'):
    cash_flows = [deposit]*terms_of_deposit + [-withdrawal]*terms_of_withdrawal
    terms = terms_of_deposit + terms_of_withdrawal
    dates = [date.today() + relativedelta(**{period + 's':i}) for i in range(terms)]
    df = pd.DataFrame(data={'cash flow': cash_flows, 'date': dates})
    return df


def retirement_problem(terms_of_deposit, 
                       withdrawal, 
                       terms_of_withdrawal, 
                       annual_discount_rate, 
                       period='year'):
    df_by_deposit = partial(get_retirement_cf_dataframe, 
                            terms_of_deposit=terms_of_deposit, 
                            withdrawal=withdrawal, 
                            terms_of_withdrawal=terms_of_withdrawal, 
                            period=period)
    f = lambda deposit: npv(retirement_dataframe_by_deposit(deposit), annual_discount_rate)
    result = fsolve(f, withdrawal)
    return list(result)
</code></pre><pre><code>&gt;&gt;&gt; retirement_problem(24, 50000, 25, 0.05)
[15822.327630785972]
</code></pre><p>That's a pretty cool result - I need to deposit only ~$16k yearly for 24 years to be able to withdraw $50k for 25 years later. That's compound interest working.</p><h2 id="continuous-compounding">Continuous compounding</h2><p>I'm using <code>convert_ir(r, from_period='year', to_period='day')</code> function to convert from annual interest rate to daily interest rate in some examples above.<br />So if I have an annual rate of 20%, a quarterly rate is:</p><pre><code>&gt;&gt;&gt; convert_ir(0.2, from_period='year', to_period='quater')
0.04663513939210562
</code></pre><p>And respective annual is:</p><pre><code>&gt;&gt;&gt; 4 * convert_ir(0.2, from_period='year', to_period='quater')
</code></pre><p>So if a bank offers a 20% annual interest rate paid quarterly the effective annual interest rate is 18.6%. So if the number of interest payments increases - for example to every millisecond - Â this is called continuous compounding. Let's calculate the annual interest rate continuously compounded given initial and end amounts.</p><pre><code>def get_annual_rate_cc(dataframe, amount_column_name='amount', date_column_name='date'):
    amount_first = dataframe[amount_column_name].iloc[0]
    amount_last = dataframe[amount_column_name].iloc[-1]
    date_first = dataframe[date_column_name].iloc[0]
    date_last = dataframe[date_column_name].iloc[-1]
    delta = relativedelta(date_last, date_first)
    t = delta.years + delta.months/12 + delta.days/365
    r = log(amount_last/amount_first)/t
    return r
</code></pre><pre><code>&gt;&gt;&gt; df = pd.DataFrame(data={'amount': [1000, 1500], 'date': [date.today(), date.today() + relativedelta(years=1, months=9)]})
&gt;&gt;&gt; print(tabulate(df, tablefmt="pipe", headers="keys"))
</code></pre><table>
<thead>
<tr>
<th></th>
<th>amount</th>
<th>date</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1000</td>
<td>2018-12-24</td>
</tr>
<tr>
<td>1</td>
<td>1500</td>
<td>2020-09-24</td>
</tr>
</tbody>
</table>
<pre><code>&gt;&gt;&gt; get_annual_rate_cc(df)
0.23169434749037965
</code></pre><p>Continuous compounding is used in many financial calculations.</p><h2 id="code">Code</h2><p>I'm planning to gather all the financial modeling methods including the ones form this post in a repo <a href="https://github.com/smirnov-am/pyfinmod">here</a>. Feel free to reach out to me over <a href="https://www.linkedin.com/in/smirnovam/">LinkedIn</a> for any questions.</p>

            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="http://smirnov-am.github.io">smirnov-am.github.io</a> &copy; 2019</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
