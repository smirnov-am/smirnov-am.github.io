<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https:\/\/smirnov-am.github.io"
        },
        "articleSection" : "post",
        "name" : "How to increase Flask performance",
        "headline" : "How to increase Flask performance",
        "description" : "How to monitor, troubleshoot and increase Flask performance",
        "inLanguage" : "en-US",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2020",
        "datePublished": "2020-05-07 23:03:00 \u002b0000 UTC",
        "dateModified" : "2020-05-07 23:03:00 \u002b0000 UTC",
        "url" : "https:\/\/smirnov-am.github.io\/flask-perf\/",
        "wordCount" : "1330",
        "keywords" : [ "Flask","Blog" ]
    }
    </script>

<title>How to increase Flask performance | Alexey Smirnov</title>

<meta property='og:title' content='How to increase Flask performance - Alexey Smirnov'>
<meta property='og:description' content='How to monitor, troubleshoot and increase Flask performance'>
<meta property='og:url' content='https://smirnov-am.github.io/flask-perf/'>
<meta property='og:site_name' content='Alexey Smirnov'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/f3f61e69a3bdf7419f19cb1be356c0b1?s=256'><meta property='article:section' content='Post'><meta property='article:tag' content='Flask'><meta property='article:published_time' content='2020-05-07T23:03:00Z'/><meta property='article:modified_time' content='2020-05-07T23:03:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@'><meta name='twitter:creator' content='@'>


<link href="https://smirnov-am.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Alexey Smirnov" />

<link rel="stylesheet" href="https://smirnov-am.github.io/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="https://smirnov-am.github.io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://smirnov-am.github.io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://smirnov-am.github.io/favicon-16x16.png">
<link rel="manifest" href="https://smirnov-am.github.io/site.webmanifest">
<link rel="mask-icon" href="https://smirnov-am.github.io/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://smirnov-am.github.io/flask-perf/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="google-site-verification" content="LxHvTgaBdcBpIRtJMFKFiIvx5Mm45WC1z1S57O6O5O8" />
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://smirnov-am.github.io">
          <h1 id="nav-heading" class="title is-4">Alexey Smirnov</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/smirnov-am'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/smirnovam'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
  
</svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UC1PS5Vov2HSkz-fKCQUiffg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
  <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
  
</svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:msc.smirnov.am@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='https://smirnov-am.github.io/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
  
</svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="https://smirnov-am.github.io/tags/aws">
          <h2 class="title is-5">AWS</h2>
        </a><a class="nav-item" href="https://smirnov-am.github.io/tags/flask">
          <h2 class="title is-5">Flask</h2>
        </a><a class="nav-item" href="https://smirnov-am.github.io/tags/python">
          <h2 class="title is-5">Python</h2>
        </a><a class="nav-item" href="https://smirnov-am.github.io/tags/vfx">
          <h2 class="title is-5">Computer vision for VFX</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="https://smirnov-am.github.io/js/navicon-shift.js"></script>
</section>
<section class="section" style="padding: 0px 0px;">
    <div class="container has-text-centered" >
      
    </div>>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="https://smirnov-am.github.io/tags/flask">#Flask</a>



      
    </div>
    <h2 class="subtitle is-6">May 7, 2020</h2>
    <h1 class="title">How to increase Flask performance</h1>
    
    <div class="content">
      <p>When Flask app runs slow we need to identify what is the bottleneck. It can be an overloaded database, unresponsive external API, or heavy, CPU-intensive computation. This is the whole recipe on how to speed up Flask - find the source of sluggish performance. After the bottleneck is identified you can fight an underlying cause.</p>
<p>And here I assume that the underlying platform that runs Flask has enough resources to do so. In the rest of this post, I&rsquo;ll explore some instruments that help with identifying bottlenecks.</p>
<h2 id="db-model">DB model</h2>
<p>Our app will use MySQL with many-to-many mapping from Students tables to Classes table - students can sign up for multiple classes and each class can accommodate many students.</p>
<p>I&rsquo;m using Flask-SQLAlchemy here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask_sqlalchemy <span style="color:#f92672">import</span> SQLAlchemy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mysql+pymysql://localhost:33066/perf&#39;</span>
</span></span><span style="display:flex;"><span>db <span style="color:#f92672">=</span> SQLAlchemy(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>student_identifier <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;student_identifier&#39;</span>,
</span></span><span style="display:flex;"><span>                              db<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;class_id&#39;</span>, db<span style="color:#f92672">.</span>Integer, db<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#39;classes.class_id&#39;</span>)),
</span></span><span style="display:flex;"><span>                              db<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;student_id&#39;</span>, db<span style="color:#f92672">.</span>Integer, db<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#39;students.student_id&#39;</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Student</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;students&#39;</span>
</span></span><span style="display:flex;"><span>    student_id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    classes <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>relationship(<span style="color:#e6db74">&#34;Class&#34;</span>, secondary<span style="color:#f92672">=</span>student_identifier)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Class</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;classes&#39;</span>
</span></span><span style="display:flex;"><span>    class_id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    students <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>relationship(<span style="color:#e6db74">&#34;Student&#34;</span>, secondary<span style="color:#f92672">=</span>student_identifier)
</span></span></code></pre></div><h2 id="views">Views</h2>
<p>Let&rsquo;s create a couple of views. One to query all the students signed up for a class</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@app</span><span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#39;/roster&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">roster</span>():
</span></span><span style="display:flex;"><span>    class_id <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;class_id&#39;</span>)
</span></span><span style="display:flex;"><span>    class_orm <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(class_id<span style="color:#f92672">=</span>class_id)<span style="color:#f92672">.</span>first_or_404()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> jsonify([c<span style="color:#f92672">.</span>name <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> class_orm<span style="color:#f92672">.</span>students])
</span></span></code></pre></div><p>Another will query all classes a student has sighed up for.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@app</span><span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#39;/my_class&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_class</span>():
</span></span><span style="display:flex;"><span>    student_id <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;student_id&#39;</span>)
</span></span><span style="display:flex;"><span>    student_orm <span style="color:#f92672">=</span> Student<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(student_id<span style="color:#f92672">=</span>student_id)<span style="color:#f92672">.</span>first_or_404()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template_string(<span style="color:#e6db74">&#39;&lt;html&gt;&lt;body&gt;data: {{ data }}&lt;/body&gt;&lt;/html&gt;&#39;</span>, data<span style="color:#f92672">=</span>[c<span style="color:#f92672">.</span>name <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> student_orm<span style="color:#f92672">.</span>classes])
</span></span></code></pre></div><p>I&rsquo;ll run flask in a development mode, as I&rsquo;d like to find the bottleneck in my code and not in middleware such as nginx or uwsgi</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="profiling-with-werkzeug-profiler">Profiling with werkzeug profiler</h2>
<p>There is a built-in profiler in werkzeug - Flaskâ€™s development web server. To use it modify the main of the app.py:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> werkzeug.middleware.profiler <span style="color:#f92672">import</span> ProfilerMiddleware
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>wsgi_app <span style="color:#f92672">=</span> ProfilerMiddleware(app<span style="color:#f92672">.</span>wsgi_app, restrictions<span style="color:#f92672">=</span>[<span style="color:#ae81ff">5</span>], profile_dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./profile&#39;</span>)
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>The profiler has 2 parameters:</p>
<ul>
<li>a number of slowest performing functions to show - I&rsquo;m putting 5</li>
<li>a directory where to put the details of the function calls</li>
</ul>
<p>The result is available in the stdout:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PATH: <span style="color:#e6db74">&#39;/my_class&#39;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">8887</span> <span style="color:#66d9ef">function</span> calls <span style="color:#f92672">(</span><span style="color:#ae81ff">8615</span> primitive calls<span style="color:#f92672">)</span> in 0.038 seconds
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   Ordered by: internal time, call count
</span></span><span style="display:flex;"><span>   List reduced from <span style="color:#ae81ff">994</span> to <span style="color:#ae81ff">5</span> due to restriction &lt;5&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   ncalls  tottime  percall  cumtime  percall filename:lineno<span style="color:#f92672">(</span><span style="color:#66d9ef">function</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">3</span>    0.004    0.001    0.004    0.001 <span style="color:#f92672">{</span>method <span style="color:#e6db74">&#39;recv_into&#39;</span> of <span style="color:#e6db74">&#39;_socket.socket&#39;</span> objects<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>    0.001    0.000    0.001    0.000 /Users/as/.virtualenvs/flask-perf/lib/python3.6/site-packages/sqlalchemy/orm/interfaces.py:558<span style="color:#f92672">(</span>create_row_processor<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">28</span>    0.001    0.000    0.001    0.000 <span style="color:#f92672">{</span>method <span style="color:#e6db74">&#39;update&#39;</span> of <span style="color:#e6db74">&#39;dict&#39;</span> objects<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">57</span>    0.001    0.000    0.001    0.000 /Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/_weakrefset.py:58<span style="color:#f92672">(</span>__iter__<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">309</span>    0.001    0.000    0.001    0.000 <span style="color:#f92672">{</span>built-in method builtins.getattr<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>It shows that most of the time the program spent communication over the network. Now let&rsquo;s have a look at what was accessing the sockets.</p>
<p>Profiler puts details of the requests in <code>profile-dir</code> directory in a *.prof files.
We can use <a href="https://github.com/jiffyclub/snakeviz/">snakeviz</a> to visualize it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install snakeviz
</span></span><span style="display:flex;"><span>snakeviz profile/GET.my_class.38ms.1588862067.prof
</span></span></code></pre></div><p>It will open a diagram in a browser. In my case it looks like that:
<img src="https://smirnov-am.github.io/content/images/flask-perf/prof_viz1.png" alt="prof_viz1">.</p>
<p>Hover over boxes on each call level to see what&rsquo;s the function being called and how long did it take. If you want to find this costly method &lsquo;recv_into&rsquo; of &lsquo;_socket.socket&rsquo; you need to click on a box to zoom in.</p>
<p>Another way of visualizing of the profiler output is to use <code>gprof2dot</code> to convert prof file to
a dot file and <code>xdot</code> draw a graph from dot file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install gprof2dot
</span></span><span style="display:flex;"><span>gprof2dot -f pstats profile/GET.my_class.38ms.1588862067.prof -o calling_graph.dot
</span></span><span style="display:flex;"><span>xdot calling_graph.dot
</span></span></code></pre></div><p>The resulting graph is:
<img src="https://smirnov-am.github.io/content/images/flask-perf/dot.png" alt="dot"></p>
<p>After investigating this visualization it&rsquo;s clear that most time is spent executing sqlachemy code (no surprise - we only do a query to the database in the Flask)</p>
<h2 id="getting-slow-sql-queries">Getting slow SQL queries</h2>
<p>Since now we know that querying the database slows us down let&rsquo;s investigate what queries we execute. There is an SQLAlchemy feature that allows us to get all the queries executed during the request. I&rsquo;ll use <code>after_request</code> Flask hook to print them when the request is over:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask_sqlalchemy <span style="color:#f92672">import</span> get_debug_queries
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_RECORD_QUERIES&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app</span><span style="color:#f92672">.</span>after_request
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">after_request</span>(response):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> query <span style="color:#f92672">in</span> get_debug_queries():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> query<span style="color:#f92672">.</span>duration <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            print(query<span style="color:#f92672">.</span>statement, query<span style="color:#f92672">.</span>parameters, query<span style="color:#f92672">.</span>duration, query<span style="color:#f92672">.</span>context)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><p>Each query returned by <code>get_debug_queries</code> has a duration attribute. In my case, I&rsquo;m printing all queries (duration &gt;= 0) but in a real case, I&rsquo;ll be interested in ones that are longer than say 1s.</p>
<p>In stdout I now can wee the queries:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SELECT students.student_id AS students_student_id, students.name AS students_name 
</span></span><span style="display:flex;"><span>FROM students 
</span></span><span style="display:flex;"><span>WHERE students.student_id <span style="color:#f92672">=</span> %<span style="color:#f92672">(</span>student_id_1<span style="color:#f92672">)</span>s 
</span></span><span style="display:flex;"><span> LIMIT %<span style="color:#f92672">(</span>param_1<span style="color:#f92672">)</span>s <span style="color:#f92672">{</span><span style="color:#e6db74">&#39;student_id_1&#39;</span>: <span style="color:#e6db74">&#39;43&#39;</span>, <span style="color:#e6db74">&#39;param_1&#39;</span>: 1<span style="color:#f92672">}</span> 0.01108407974243164 /Users/as/Desktop/flask-perf/app.py:40 <span style="color:#f92672">(</span>my_class<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Now I can substitute bind variables with values and put EXPLAIN before the query in SQL console to see how it was executed by the server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EXPLAIN SELECT students.student_id AS students_student_id, students.name AS students_name 
</span></span><span style="display:flex;"><span>FROM students 
</span></span><span style="display:flex;"><span>WHERE students.student_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span> 
</span></span><span style="display:flex;"><span>LIMIT 1;
</span></span></code></pre></div><table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>partitions</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>filtered</th>
<th>Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>SIMPLE</td>
<td>students</td>
<td></td>
<td>ALL</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>10016</td>
<td>10</td>
<td>Using where</td>
</tr>
</tbody>
</table>
<p>The <code>type</code> column says that it was an ALL type query and it means that MySQL was unable to identify any keys that can be used. So if we set a proper index the query should run faster.</p>
<h2 id="flask-debugtoolbar">Flask-DebugToolbar</h2>
<p>More high-level tools can profile Flask. One of them is a <code>flask-debugtoolbar</code>. It&rsquo;s simple to install with <code>pip install flask-debugtoolbar</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask_debugtoolbar <span style="color:#f92672">import</span> DebugToolbarExtension
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;verysecretsuchwow&#39;</span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;DEBUG_TB_PROFILER_ENABLED&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>debug <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>toolbar <span style="color:#f92672">=</span> DebugToolbarExtension(app)
</span></span></code></pre></div><p>Now in every response with an HTML page, there will be a toolbar on a right-hand sight. There we can see SQLAlchemy queries and execute EXPLAIN right from the browser:<img src="debtb1.png" alt="tb1"></p>
<p>There is a profiler output as well:
<img src="https://smirnov-am.github.io/content/images/flask-perf/debtb2.png" alt="tb2"></p>
<h2 id="api-monitoring">API monitoring</h2>
<p>All the mentioned methods need you to make an actual call to get the profiler data. They do not store the results of your user&rsquo;s call, nor they provide statistics on what endpoints perform worst.</p>
<p>2 plugins allow monitoring such a performance: <code>Flask-MonitoringDashboard</code> and <code>flask-profiler</code></p>
<p>Installation of both plugins is simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install flask_profiler Flask-MonitoringDashboard
</span></span></code></pre></div><h3 id="flask-monitoringdashboard">Flask-MonitoringDashboard</h3>
<p>The setup for the dashboard looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> flask_monitoringdashboard <span style="color:#66d9ef">as</span> dashboard
</span></span><span style="display:flex;"><span>dashboard<span style="color:#f92672">.</span>bind(app)
</span></span></code></pre></div><p>The dashboard is using SQLite by default (you&rsquo;ll get a .db file in the root directory of the project). The dashboard is available under <code>/dashboard</code> (default credentials are admin/admin)</p>
<p>In the API performance section, you can find statistics (nice block diagrams) showing response time distributions of our endpoints:</p>
<p><img src="https://smirnov-am.github.io/content/images/flask-perf/fdb1.png" alt="fdb1"></p>
<p>In the overview section, you can select a log level. If you select #3 you will access a profiler data that shows the call stack and timings for every request being made</p>
<p><img src="fdb2.png" alt="fdb2"></p>
<p>There are a bunch of configuration options this a profiler. See the docs <a href="https://flask-monitoringdashboard.readthedocs.io/en/latest/configuration.html">here</a></p>
<h3 id="flask-profiler">flask-profiler</h3>
<p>Setup the profiler like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask_profiler <span style="color:#f92672">import</span> Profiler
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#34;flask_profiler&#34;</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;enabled&#34;</span>: app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#34;DEBUG&#34;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;storage&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;engine&#34;</span>: <span style="color:#e6db74">&#34;sqlite&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;basicAuth&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;admin&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;ignore&#34;</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;^/static/.*&#34;</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Profiler(app)
</span></span></code></pre></div><p>The dashboard is also using SQLite by default (but MongoDB and SQLAlchemy are available backends). The dashboard is available under /flask-profile (default credentials are admin/admin)</p>
<p>On the overview page there is a statistics of our endpoint&rsquo;s usage:</p>
<p><img src="https://smirnov-am.github.io/content/images/flask-perf/fpf1.png" alt="fpf1"></p>
<p>In the settings there is a list of all requests where we can see that was  passed to the server:</p>
<p><img src="https://smirnov-am.github.io/content/images/flask-perf/fpf2.png" alt="fpf2"></p>
<p>Both dashboards are meant to be used when Flask is in debug mode and I wouldn&rsquo;t put them on in a production environment. So the best approach to work with them is to enable them on a development machine and run a test using ab, siege, or JMeter and analyze the results afterward.</p>
<h2 id="final-thoughts">Final thoughts</h2>
<p>Only after identifying an underlying cause for slow responses, you can start dealing with them. In my career I&rsquo;ve encountered such situations:</p>
<ul>
<li>
<p>In case if slow DB queries - use EXPLAIN to see if the server uses the index for querying the data.</p>
</li>
<li>
<p>Or you may spin up a read-replica DB to steer read requests to it if you&rsquo;ve reached a limit with vertical scaling of the DB server.</p>
</li>
<li>
<p>If it&rsquo;s a slow API or CPU intensive job - consider putting it in an <a href="https://smirnov-am.github.io/background-jobs-with-flask/">async background job</a>.</p>
</li>
</ul>
<p>Please, reach me out on <a href="linkedin.com/in/smirnovam">LinkedIn</a> you you find this post useful and want to share your experience with
slow Flask performance</p>


      <section class="section">
  <p>Support the author - <a href="https://www.buymeacoffee.com/smirnovam">Buy me a coffee!</a></p>
</section>
    <script>talkyardServerUrl='https:\/\/comments-for-smirnov-am-github-io.talkyard.net';</script>
    <script async defer src="https://c1.ty-cdn.net/-/talkyard-comments.min.js"></script>
    
    <div class="talkyard-comments" data-discussion-id="flask-perf" style="margin-top: 45px;">
    <noscript>Please enable Javascript to view comments.</noscript>
    <p style="margin-top: 25px; opacity: 0.9; font-size: 96%">Comments powered by
    <a href="https://www.talkyard.io">Talkyard</a>.</p>
    </div>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="https://smirnov-am.github.io/deploy-flask/">5 ways to deploy Flask</a></li>
	
	<li><a href="https://smirnov-am.github.io/run-flask-on-aws-ecs/">Run Flask on AWS ECS (Fargate)</a></li>
	
	<li><a href="https://smirnov-am.github.io/streaming-timeseries-with-flask-and-plotly/">Streaming timeseries with Flask and Plotly</a></li>
	
	<li><a href="https://smirnov-am.github.io/background-jobs-with-flask/">Background jobs with Flask</a></li>
	
	<li><a href="https://smirnov-am.github.io/multitenancy-with-flask/">Multitenancy with Flask</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="https://smirnov-am.github.io/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>&copy; Alexey Smirnov 2021</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-107429956-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

