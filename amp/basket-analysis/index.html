<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https:\/\/smirnov-am.github.io"
        },
        "articleSection" : "post",
        "name" : "E-commerce recommendation systems: basket analysis.",
        "headline" : "E-commerce recommendation systems: basket analysis.",
        "description" : "Exploring implementation of basket analysis algorithms - Apriori, Eclat, FP-Growth",
        "inLanguage" : "en-US",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2018",
        "datePublished": "2018-04-08 12:18:00 \x2b0000 UTC",
        "dateModified" : "2018-04-08 12:18:00 \x2b0000 UTC",
        "url" : "https:\/\/smirnov-am.github.io\/amp\/basket-analysis\/",
        "wordCount" : "1511",
        "keywords" : [ "Python","machine learning","Blog" ]
    }
    </script>

<title>E-commerce recommendation systems: basket analysis. | Alexey Smirnov</title>

<meta property='og:title' content='E-commerce recommendation systems: basket analysis. - Alexey Smirnov'>
<meta property='og:description' content='Exploring implementation of basket analysis algorithms - Apriori, Eclat, FP-Growth'>
<meta property='og:url' content='https://smirnov-am.github.io/amp/basket-analysis/'>
<meta property='og:site_name' content='Alexey Smirnov'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/f3f61e69a3bdf7419f19cb1be356c0b1?s=256'><meta property='article:section' content='Post'><meta property='article:tag' content='Python'><meta property='article:tag' content='machine learning'><meta property='article:published_time' content='2018-04-08T12:18:00Z'/><meta property='article:modified_time' content='2018-04-08T12:18:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@'><meta name='twitter:creator' content='@'>


<link href="https://smirnov-am.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Alexey Smirnov" />

<link rel="stylesheet" href="https://smirnov-am.github.io/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="https://smirnov-am.github.io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://smirnov-am.github.io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://smirnov-am.github.io/favicon-16x16.png">
<link rel="manifest" href="https://smirnov-am.github.io/site.webmanifest">
<link rel="mask-icon" href="https://smirnov-am.github.io/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://smirnov-am.github.io/amp/basket-analysis/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="google-site-verification" content="LxHvTgaBdcBpIRtJMFKFiIvx5Mm45WC1z1S57O6O5O8" />
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://smirnov-am.github.io">
          <h1 id="nav-heading" class="title is-4">Alexey Smirnov</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/smirnov-am'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/smirnovam'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
  
</svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UC1PS5Vov2HSkz-fKCQUiffg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
  <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
  
</svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:msc.smirnov.am@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='https://smirnov-am.github.io/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
  
</svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="https://smirnov-am.github.io/tags/aws">
          <h2 class="title is-5">AWS</h2>
        </a><a class="nav-item" href="https://smirnov-am.github.io/tags/flask">
          <h2 class="title is-5">Flask</h2>
        </a><a class="nav-item" href="https://smirnov-am.github.io/tags/python">
          <h2 class="title is-5">Python</h2>
        </a><a class="nav-item" href="https://smirnov-am.github.io/tags/vfx">
          <h2 class="title is-5">Computer vision for VFX</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="https://smirnov-am.github.io/js/navicon-shift.js"></script>
</section>
<section class="section" style="padding: 0px 0px;">
    <div class="container has-text-centered" >
      <a href="https://github.com/smirnov-am/serverless-saas-template"><img src="https://smirnov-am.github.io/content/images/saas-ad.png"></a>
    </div>>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="https://smirnov-am.github.io/tags/python">#Python</a>



  
  | <a class="subtitle is-6" href="https://smirnov-am.github.io/tags/machine-learning">#machine learning</a>
  

      
    </div>
    <h2 class="subtitle is-6">April 8, 2018</h2>
    <h1 class="title">E-commerce recommendation systems: basket analysis.</h1>
    
    <div class="content">
      

<p>Once novelty recommendation systems are used now by more and more e-commerce sites to help customers find products to purchase. For e-commerce business owners these tools facilitate cross-sales.</p>

<h2 id="usage">Usage</h2>

<p>Amazon is one of the most prominent organizations that used recommendations to increase sales. According to <a href="http://fortune.com/2012/07/30/amazons-recommendation-secret/" target="_blank">fortune.com</a> Amazon was able to increase sales by 29% in 2012 as a result of implementing recommendation system. 35% of Amazon’s revenue is generated by its recommendation engine <a href="https://www.mckinsey.com/industries/retail/our-insights/how-retailers-can-keep-up-with-consumers" target="_blank">(source)</a>.</p>

<p>Amazon is using <a href="https://www.computer.org/csdl/mags/ic/2017/03/mic2017030012.html" target="_blank">collaborative filtering approach</a></p>

<p>However there is another approach to mine items that a frequently bought together - <strong>association rule mining</strong>.</p>

<p>The difference is the unit of aggregation: collaborative filtering unit is user or items.</p>

<p>With user-to-user collaborative filtering approach algorithm finds a user which similar to you and suggests to buy the same items he bought. This is computationally difficult as there might be more users than items or users have very dissimilar interests.</p>

<p>With item-to-item collaborative filtering approach which is used by Amazon, algorithm finds a neighborhood of items that are bought/viewed by you and users that bought viewed the same item. Then items from that neighborhood are displayed as recommendations.</p>

<p>Association rule unit is a session (order), which makes this approach less personalized, as users and user purchase history is not taken into account. But it has some strong points:</p>

<ul>
<li>it’s extremely simple and fast</li>
<li>it will work with very small and sparse customer bases</li>
<li>knowledge of the customer beyond what products or services they currently have is not necessary</li>
</ul>

<p>However, there is one major drawback that makes association rule algorithms less favored by e-commerce - inability to catch so called &ldquo;long tail&rdquo; - online stores have a lot of items and some of them are bought rarely. But among these rare items there might be a pair that are of interested to specific group of people. Association rules are unlikely to finds them.</p>

<p>But these algorithms are useful for offline stores, where it&rsquo;s not possible to track users and find application in other areas.</p>

<h2 id="algorithms">Algorithms</h2>

<p><a href="http://www.vldb.org/conf/1994/P487.PDF" target="_blank"><strong>Apriori</strong></a>: it was introduced in 1993 , more than 20 years ago. It remains one of the most important data mining algorithms, not because it is the fastest, but because it has influenced the development of many other algorithms <a href="http://data-mining.philippe-fournier-viger.com/classic-data-mining-algorithm-1-apriori/" target="_blank">(source)</a></p>

<p><strong>Apriori-TID</strong>: is a variation of the Apriori algorithm. It was proposed in the same article as Apriori as an alternative implementation. It produces the same output, but does less scans of the transaction database</p>

<p><a href="https://www.slideshare.net/deepa15/eclat-37310304" target="_blank"><strong>Eclat</strong></a>: is faster than Apriori, but less memory efficient</p>

<p><a href="http://dx.doi.org/10.1145/335191.335372" target="_blank"><strong>FP-Growth</strong></a>: most advanced and efficient implementation of frequent pattern mining</p>

<h2 id="input-parameters">Input parameters</h2>

<ul>
<li><em>order list</em>: database of all orders (transactions). Each entry is a subset of all items that are being sold (here item count is dropped)</li>
</ul>

<p>Example:</p>

<pre><code>1 {item1, item3, item4}
2 {item2, item3, item5}
3 {item1, item2, item3, item5}
4 {item2, item5}

</code></pre>

<ul>
<li><em>list of all possible items on sale</em>: optional parameter that can be determined by scanning order list once</li>
</ul>

<p>Example: <code>items = {item1, item2, item3, item4, item5}</code></p>

<ul>
<li><em>minimum support</em>: minimum frequency for an item or itemset to count as frequent</li>
</ul>

<p>Example: <code>min_support=0.1</code> means that we are interested in items or itemsets that appeared in minimum 10% of all orders</p>

<ul>
<li><em>minimum confidence</em>: parameter that says how likely item Y is purchased when item X is purchased, expressed as {X -&gt; Y}. This is measured by the proportion of transactions with item X, in which item Y also appears</li>
</ul>

<p>This can be calculated like so <code>confidence({X -&gt; Y}) = support({X, Y}) / support(X)</code></p>

<ul>
<li><em>minimum lift</em> (optional as not used in many implementations): parameter that says how likely item Y is purchased when item X is purchased, while controlling for how popular item Y is. A lift value greater than 1 means that item Y is likely to be bought if item X is bought, while a value less than 1 means that item Y is unlikely to be bought if item X is bought</li>
</ul>

<p>Formula for lift is <code>lift({X -&gt; Y}) = support({X, Y}) / (support(X) * support(Y))</code></p>

<h2 id="output">Output:</h2>

<p>A list of rules in a form (<code>from_itemset</code>, <code>to_itemset</code>, <code>confidence</code>, <code>lift</code>), where <code>from_itemset</code> and <code>to_itemset</code> are subsets of items on sale.</p>

<h2 id="making-a-recommendation">Making a recommendation</h2>

<p>Recommendation can be made, for example at a checkout, when user has item1 and item2 in the shopping cart. In that case <code>from_itemset = {item1, item2}</code> and using the list of rules we may find respective<code>to_itemset</code> with maximum confidence and/or lift.</p>

<h2 id="apriori-algorithm">Apriori algorithm.</h2>

<h3 id="1st-step">1st step:</h3>

<p>Let the <code>candidates_1</code> set to contain all individual items.</p>

<p>Now let&rsquo;s calculate support for each <code>candidate</code> in <code>candidates_1</code>.</p>

<p>Populate <code>layer_1</code> set with those candidates, which support is &gt;= <code>min_support</code></p>

<h3 id="2nd-step">2nd step:</h3>

<p>Let the <code>candidates_2</code> be populated with all pairs from <code>layer_1</code></p>

<p>For example, if <code>layer_1 = {item1, item3, item4}</code></p>

<p>then <code>candidates_2 = [{item1, item3}, {item1, item4}, {item3, item4}]</code></p>

<p>Now let&rsquo;s calculate support for each <code>candidate</code> in <code>candidates_2</code> as in previous step by going through each order in order list. Populate <code>layer_2</code> with those candidates from <code>candidates_2</code>, which support is &gt;= <code>min_support</code></p>

<h3 id="nth-step">Nth step:</h3>

<p>Repeat step 2 until you can form candidates sets. Candidates for a next step are formed from a layer of a current step by unions of all possible pairs in layer set (elements of a layer should be sets to support this). This is also known as self-join. This is how support dictionary - filtered set of combinations of items and their respective support - is formed.</p>

<p>In each step populate a support dictionary using itemsets as keys and their correspondent support as values.</p>

<h3 id="association-rules">Association rules</h3>

<p>Next step is to calculate all association rules. Let&rsquo;s fix a hyper-parameters <code>min_confidence</code> and <code>min_lift</code>.</p>

<p>For all sets <code>L</code> in support dictionary create all non-empty subsets <code>S</code> of <code>L</code>, and evaluate confidence and lift for a rule <code>{S -&gt; L-S}</code> and save rules, whose parameters are greater of equal than minimal.</p>

<p><em>In a notion {X -&gt; Y}, X is called from-itemset, and Y - to-itemset.</em></p>

<h2 id="apriori-tid">Apriori-TID</h2>

<ul>
<li>the order list is not used at all for counting the support of candidate itemsets after the first pass.</li>
<li>the candidate itemsets are generated the same way as in Apriori algorithm</li>
<li>rules are generated the same way after support dictionary is populated.
The only different is that in each layer &gt; 1 a separate list <code>C'</code> is created. <code>C'</code> hold transaction IDs with corresponding itemsets from candidates on that layer that are in that particular transaction.</li>
</ul>

<p>For example, using order list from above first layer would yield such support dictionary:</p>

<pre><code>item1 0.5
item2 0.75
item3 0.75 
item5 0.75

</code></pre>

<p>Second layer candidates set is:</p>

<pre><code>{item1, item2} 0.25
{item1, item3} 0.5 *
{item1, item5} 0.25
{item2, item3} 0.5 *
{item2, item5} 0.75 *
{item3, item5} 0.5 *

</code></pre>

<p>So <code>layer_2</code> will consist from itemsets with <code>*</code>. And at this step a separate data structure is created to hold transaction IDs for these sets that made it to <code>layer_2</code></p>

<pre><code>1 {item1, item3}
2 {item2, item3} {item2, item5} {item3, item5}
3 {item1, item2} {item1, item3} {item1, item5} {item2, item3} {item2, item5} {item3, item5}
4 {item2, item5}

</code></pre>

<p>Using this additional list we will calculate support for candidates for <code>layer_3</code>.</p>

<h2 id="eclat">Eclat</h2>

<p>Another way to speedup support calculation is to keep a list of transaction IDs for every itemset at each layer. It speeds up support calculation even more, but these transaction lists can be large in size.</p>

<p>Again using the same order list in first step, transaction ID list will be</p>

<pre><code>item1 1, 3
item2 2, 3, 4
item3 1, 2, 3
item4 1
item5 2, 3, 4

</code></pre>

<p>item4 won&rsquo;t be included in the next layer, and this list can help us to calculate lists for all possible pairs for the next step:</p>

<pre><code>{item1 item2} 3
{item1 item3} 1, 3
{item1 item4} 1
{item1 item5} 3
{item2 item3} 2, 3
...etc

</code></pre>

<h2 id="fp-growth">FP-Growth</h2>

<p>This one is different from Apriori-like algorithms in a way that candidate itemsets are not generated explicitly. FP-growth uses a suffix tree (FP-tree) structure to encode transactions thus speeds up support calculation.</p>

<h2 id="tests">Tests</h2>

<p>Dataset was taken from <a href="http://archive.ics.uci.edu/ml/datasets/Online+Retail" target="_blank">http://archive.ics.uci.edu/ml/datasets/Online+Retail</a>  <em>Daqing Chen, Sai Liang Sain, and Kun Guo, Data mining for the online retail industry: A case study of RFM model-based customer segmentation using data mining, Journal of Database Marketing and Customer Strategy Management, Vol. 19, No. 3, pp. 197â€“208, 2012 (Published online before print: 27 August 2012. doi: 10.1057/dbm.2012.17).</em></p>

<h3 id="preprocessing">Preprocessing</h3>

<p>As each row contains <code>InvoiceNo</code> and <code>StockCode</code>, let&rsquo;s group items by <code>InvoiceNo</code></p>

<pre><code>import csv
from collections import defaultdict

order_list = defaultdict(list)

with open('data.csv', encoding=&quot;iso-8859-1&quot;) as f:
    csv_reader = csv.DictReader(f)
    for row in csv_reader:
        order_list[row['InvoiceNo']].append(row['StockCode'])

</code></pre>

<p>Some stats of the dataset:</p>

<ul>
<li>number of orders: 25900</li>
<li>4070 items on sale</li>
<li>minimum order: 1 item</li>
<li>maximum order: 1114 items</li>
<li>mean order size: ~21 items</li>
</ul>

<h3 id="python-implementation">Python implementation</h3>

<p>I&rsquo;ve implemented all 4 aforementioned algorithms <a href="https://github.com/smirnov-am/pyfreqpm" target="_blank">here</a>. FP-Growth needs some more testing though, so I&rsquo;ve used <a href="https://spark.apache.org/docs/2.3.0/mllib-frequent-pattern-mining.html" target="_blank">Apache Spark</a></p>

<h3 id="generated-rules">Generated rules</h3>

<p>All algorithms showed same 3 rules, with 2nd and 3rd being the same pair.</p>

<p>Not very impressive findings, so it worth trying to experiment with different input parameters. But based on them we can recommend someone buying &ldquo;JUMBO BAG PINK POLKADOT&rdquo; to get a &ldquo;JUMBO BAG RED RETROSPOT&rdquo; as well. Same goes for teacups.</p>


      <section class="section">
  <p>Support the author - <a href="https://www.buymeacoffee.com/smirnovam">Buy me a coffee!</a></p>
</section>
    <script>talkyardServerUrl='https:\/\/comments-for-smirnov-am-github-io.talkyard.net';</script>
    <script async defer src="https://c1.ty-cdn.net/-/talkyard-comments.min.js"></script>
    
    <div class="talkyard-comments" data-discussion-id="basket-analysis" style="margin-top: 45px;">
    <noscript>Please enable Javascript to view comments.</noscript>
    <p style="margin-top: 25px; opacity: 0.9; font-size: 96%">Comments powered by
    <a href="https://www.talkyard.io">Talkyard</a>.</p>
    </div>

      
      <div class="related">
</div>
      
    </div>
    
  </div>
</section>

    <script src="https://smirnov-am.github.io/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>&copy; Alexey Smirnov 2021</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-107429956-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

