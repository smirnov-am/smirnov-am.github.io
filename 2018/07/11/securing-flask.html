<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Securing Flask web applications. | Alexey Smirnov</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="Securing Flask web applications." />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve just recently finished a web security training and in this post I’d like to investigate security mechanisms of my beloved web framework - Flask. I’ll go through different types of possible vulnerabilities and the way they can be mitigated." />
<meta property="og:description" content="I’ve just recently finished a web security training and in this post I’d like to investigate security mechanisms of my beloved web framework - Flask. I’ll go through different types of possible vulnerabilities and the way they can be mitigated." />
<link rel="canonical" href="http://localhost:4000/2018/07/11/securing-flask.html" />
<meta property="og:url" content="http://localhost:4000/2018/07/11/securing-flask.html" />
<meta property="og:site_name" content="Alexey Smirnov" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-11T00:00:00+02:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2018/07/11/securing-flask.html","description":"I’ve just recently finished a web security training and in this post I’d like to investigate security mechanisms of my beloved web framework - Flask. I’ll go through different types of possible vulnerabilities and the way they can be mitigated.","headline":"Securing Flask web applications.","datePublished":"2018-07-11T00:00:00+02:00","dateModified":"2018-07-11T00:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/07/11/securing-flask.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Alexey Smirnov" /></head>
<body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/">Alexey Smirnov</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
        <div class="trigger">
          <a class="page-link" href="https://www.linkedin.com/in/smirnovam/">Linkedin</a>
          <a class="page-link" href="https://github.com/smirnov-am">GitHub</a>
          <a class="page-link" href="https://tinyletter.com/smirnov-am">Newsletter</a>
        </div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Securing Flask web applications.</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-07-11T00:00:00+02:00" itemprop="datePublished">Jul 11, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I’ve just recently finished a web security training and in this post I’d like to investigate security mechanisms of my beloved web framework - Flask.
I’ll go through different types of possible vulnerabilities and the way they can be mitigated.</p>

<h2 id="xss">XSS</h2>
<p>Cross-Site Scripting (XSS) attacks are a type of injection, in which malicious scripts are injected into otherwise benign and trusted websites. <a href="https://www.owasp.org/index.php/Cross-site_Scripting_%28XSS%29">source</a></p>

<h3 id="exploit">Exploit</h3>
<p>Consider a form asking for a user input.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"/"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"tweet"</span><span class="nt">&gt;&lt;br&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>And a template to show tweets by other users where user input from above form passed unprocessed:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;title&gt;</span>Hello from flask twitter<span class="nt">&lt;/title&gt;</span>
{% for tweet in tweets %}
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">{{tweet}}</span><span class="nt">&gt;</span>{{ tweet }}!<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{tweet}}"</span><span class="nt">&gt;</span>Like<span class="nt">&lt;/a&gt;</span>
{% endfor %}

</code></pre></div></div>

<p>With the Flask app looking like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">make_response</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">tweets</span> <span class="o">=</span> <span class="p">[]</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">tweet_feed</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'tweet'</span><span class="p">]</span>
        <span class="n">tweets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'tweet_feed.html'</span><span class="p">,</span> <span class="n">tweets</span><span class="o">=</span><span class="n">tweets</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5005</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>The tweet posted by user will be used as <code class="highlighter-rouge">h1</code> class attribute and inside the tag and also as <code class="highlighter-rouge">a</code> href attribute.</p>

<p>A hacker may post malicious code and when another users will open the page with tweets that code may be executed by their browsers:</p>

<ol>
  <li><code class="highlighter-rouge">" onload=alert(1)</code> - if this appears in class attribute it will close the double quote and add a callback to onload event for this DOM.</li>
  <li><code class="highlighter-rouge">javascript:alert(1);</code> - if this javascript URI appears in href attribute, browser will execute a code when user clicks.</li>
  <li><code class="highlighter-rouge">&lt;script&gt;alert(1)&lt;/script&gt;</code> - if this appears anywhere on the page the script will be executed.</li>
</ol>

<p>The script may not just show an alert message, but for example do an AJAX call to another endpoint on this site (i.e. password change).  This allows the attacker to perform any action as the user on this website.</p>

<h3 id="mitigation">Mitigation</h3>
<p>When rendering templates Flask configures Jinja2 to automatically escape all values unless explicitly told otherwise. Autoescaping is not enabled for all templates.
The following extensions for templates trigger autoescaping: .html, .htm, .xml, .xhtml. Templates loaded from a string will have autoescaping disabled.</p>

<p>So because of the above exploit using code #3 will be escaped and never executed.</p>

<p>Code #1 gives me <code class="highlighter-rouge">ERR_BLOCKED_BY_XSS_AUDITOR</code> error in Chrome Version 65.0.3325.181. This browser behaviour can be manipulated by the server with <code class="highlighter-rouge">X-XSS-Protection</code> header <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection">source</a></p>

<p>The only vulnerable part is href attribute in <code class="highlighter-rouge">a</code> tag.
We have a following option to mitigate</p>
<ul>
  <li>do not use user input with <code class="highlighter-rouge">href</code></li>
  <li>use `` when rendering template. This has additional benefit of automatically building proper URLs if endpoint path changes.</li>
  <li>use  <code class="highlighter-rouge">Content-Security-Policy</code> header in response:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">tweet_feed</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">tweet</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'tweet'</span><span class="p">]</span>
        <span class="n">tweets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">'tweet_feed.html'</span><span class="p">,</span> <span class="n">tweets</span><span class="o">=</span><span class="n">tweets</span><span class="p">))</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Content-Security-Policy'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"default-src 'self'"</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div>

<p>Content Security Policy (CSP) is security mechanism aimed at protecting from XSS and Clickjacking attacks. CSP allows you to specify trusted origins of loading resources such as Javascript, fonts, CSS and others. And also ban the execution of the built-in Javascript code. <a href="https://web-security.guru/en/web-security/content-security-policy">source</a></p>

<p><code class="highlighter-rouge">default-src 'self'</code> in <code class="highlighter-rouge">Content-Security-Policy</code> header in server response instructs browser to load and execute scripts from the same source - your server, which is identified by protocol (http/https), hostname and port triplet. It also disables inline scripts like the one from malicious code #3.</p>

<p>Another types of XSS are the ones where malicious code is embedded in uploaded file (text, images). I’ll address them in File upload section later</p>

<h2 id="csrf">CSRF</h2>
<p>Cross-Site Request Forgery is an attack that allows an attacker to make requests to various sites under victim user. If the victim comes to a site containing a malicious code, a request is sent from her username to another service (social network) performing a destructive action.
Unlike XSS the malicious code is stored on hacker controlled server where user is tricked to visit.</p>

<h2 id="exploit-1">Exploit</h2>

<p>Consider a online bank transfer page. You may access it by logging beforehand with the authentication information stored in cookie files.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;title&gt;</span>Hello from Flask<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;h1&gt;</span>Account balance $<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;h2&gt;</span>New transfer<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"/"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"destination_account"</span> <span class="na">placeholder=</span><span class="s">"Destination account"</span><span class="nt">&gt;&lt;br&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"number"</span> <span class="na">name=</span><span class="s">"amount"</span><span class="nt">&gt;&lt;br&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Transfer"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>With Flaks app looking like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">account_balance</span> <span class="o">=</span> <span class="mi">1000</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">transfer</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">account_balance</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">transferred_amount</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'amount'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">transferred_amount</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">account_balance</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transferred_amount</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">'transfer.html'</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="n">account_balance</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5005</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>Now an attacker may trick you to follow a link to his website (I’m getting a lot of ‘Your transaction is approved, Follow this link for details’ spam messages recently).
When you follow the link a page with the following script loads:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"http://0.0.0.0:5005/"</span> <span class="na">id=</span><span class="s">"hacker_form"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"destination_account"</span> <span class="na">value=</span><span class="s">"123123123"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"number"</span> <span class="na">name=</span><span class="s">"amount"</span> <span class="na">value=</span><span class="s">"1000"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Transfer"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;script&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"hacker_form"</span><span class="p">).</span><span class="nx">submit</span><span class="p">()</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>So when sending this form to bank app at http://0.0.0.0:5005/ authorization cookie will be also sent along. Thus user authorized bank to transfer $10000 to Account #123123123</p>

<h3 id="mitigation-1">Mitigation</h3>
<p>I’ve used endpoint that changes the state of account only on POST request. That complicated hacker’s task a little bit as he needs user to visit his server with malicious code.
If it was just GET user only need to click the link without loading the script from hacker’s server.</p>

<p>Another security measure is to use tokens with each account state change endpoint.
With every form user gets a random token (as a form’s hidden field) and when form is POSTed, the token is checked for validity and expiration.
In Flask this is implemented in <a href="http://flask-wtf.readthedocs.io/en/stable/">Flask-WTF plugin</a></p>

<p>Outline
1) GET requests should not change the state of the system
2) Check <code class="highlighter-rouge">Origin</code> and/or <code class="highlighter-rouge">Referer</code> request header in server code to match real server name
3) Use CSRF-tokens</p>

<h2 id="sql-injection">SQL Injection</h2>
<p>SQL Injection occurs when attacker-controlled input is inserted into a SQL query without proper validation or sanitization. This often occurs when using string formatting or concatenation to build queries.
An attacker may be able to read data for which they are not authorized, tamper with or destroy data, or possibly even write files or execute code on the database server. The impact is dependent on the exact scenario, but is generally quite severe.</p>

<h3 id="exploit-2">Exploit</h3>
<p>Consider bank transfer form from the above example with the following Flask app (I’m using SQLAlchemt here and trying to put things simple, but usually it’s not how you manage database session in Flask app)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite:///123.db'</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">transfer</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)()</span>
    <span class="n">account_balance_query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT balance from accounts WHERE number=1111'</span><span class="p">)</span>
    <span class="n">account_balance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">account_balance_query</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">transferred_amount</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'amount'</span><span class="p">]</span>
        <span class="n">destination_account</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'destination_account'</span><span class="p">]</span>
        <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'UPDATE accounts SET balance = balance - '</span> <span class="o">+</span> <span class="n">transferred_amount</span> <span class="o">+</span> <span class="s">' WHERE number=1111'</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'UPDATE accounts SET balance = balance + '</span> <span class="o">+</span> <span class="n">transferred_amount</span> <span class="o">+</span> <span class="s">' WHERE number='</span> <span class="o">+</span> <span class="n">destination_account</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'transfer'</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">'transfer.html'</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="n">account_balance</span><span class="p">))</span>
    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span>

</code></pre></div></div>
<p>I’ve tried to break all the rules here: building raw queries and concatenating query string with user input directly (I might have used <code class="highlighter-rouge">.format</code> as well).
So when enetring <code class="highlighter-rouge">2222;DROP DATABASE;</code> in destination account input field I expected this particular line
<code class="highlighter-rouge">session.execute('UPDATE accounts SET balance = balance + ' + transferred_amount + ' WHERE number=' + destination_account)</code>
execute an update and then drop database.
But it gave me that error <code class="highlighter-rouge">sqlite3.Warning: You can only execute one statement at a time.</code> and no changes were made to database.
Not all drivers have that protection, while <a href="http://dev.mysql.com/doc/connector-python/en/connector-python-api-mysqlcursor-execute.html">some</a> allow multiple statement to be executed like so.</p>

<h3 id="mitigation-2">Mitigation</h3>
<p>The proper way to avoid that is to use ORMs. In that case the Flask app will be like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite:///123.db'</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'accounts'</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">transfer</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)()</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="s">'1111'</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">transferred_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'amount'</span><span class="p">])</span>
        <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">transferred_amount</span>
        <span class="n">destination_account_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'destination_account'</span><span class="p">]</span>
        <span class="n">destination_account</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">destination_account_number</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="n">destination_account</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">transferred_amount</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'transfer'</span><span class="p">))</span>
    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">'transfer.html'</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="n">account</span><span class="o">.</span><span class="n">balance</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div>

<h2 id="directory-traversal">Directory traversal</h2>
<p>Directory traversal may happen when for example an attacker uploads a file with a filename like <code class="highlighter-rouge">../../../etc/passwd</code>. If he guessed the number of <code class="highlighter-rouge">..</code> right he might overwrite the file (given that uwsgi or Flask is running as root, but it may be any other file like <code class="highlighter-rouge">~/bash.rc</code>).
The mitigation is explained in official Flask docs <a href="http://flask.pocoo.org/docs/1.0/patterns/fileuploads/">here</a></p>

<p>Essentially you need to sanitize filenames from file upload form. Another advice is avoid using user provided filenames at all and generate your own (hash of the datetime/username/etc) and store them on a separate subdomain (more on it later)</p>

<h2 id="xss-in-uploaded-files">XSS in uploaded files</h2>
<p>This is not particualrly related to Flask, but malicious javascript might appear not only in reflected output or stored in database (see general XSS attack), but it can also be embedded in images.
For example, <a href="https://marcoramilli.blogspot.com/2014/01/hacking-through-image-gif-turn.html">this blog post</a>
uses that <a href="https://pastebin.com/6yUbfGX5">code</a> to embed javascript in GIF image file. CSP won’t help here - so the only way is to serve the images from separate subdomain (that’s what actually Facebook does)</p>

<p>Another thing related to files is how to you actually serve them. A pdf document uploaded by an attacker may have malicious code so if that file is server to another users it’s better to add <code class="highlighter-rouge">Content-Disposition: attachment</code> header to server response so browser will download it instead of showing right away.</p>

<h2 id="cookie-protection">Cookie protection</h2>
<p>Cookie files are used for a lot of things along with storing session or authentication data.
There are some methods to protect them from exposing to an attacker</p>

<h3 id="secure">Secure</h3>
<p>Cookies are sent with every request in clear text:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /index.html HTTP/1.1
Host: www.example.org
Cookie: <span class="nv">session</span><span class="o">=</span>XXXXXXX
</code></pre></div></div>
<p>It means that if an attacker that controls network equipment between you and server (or your ISP) can easily read it.
Setting cookie <code class="highlighter-rouge">secure</code> flag will instruct browser to send a cookie only over protected HTTPS connection.</p>

<h3 id="http-only">HTTP Only</h3>
<p><code class="highlighter-rouge">HttpOnly</code> flag will instruct browser to hide cookie content from javascript code. In case of XSS attack it will prevent an attacker from accessing sensitive data stored in it.</p>

<h3 id="samesite">SameSite</h3>
<p>In the CSRF example the critical part of the attack was that user’s cookie was send from attacker controlled site. It can be mitigated by setting <code class="highlighter-rouge">SameSite=strict</code>.
Another option for that flag is ‘lax’ which won’t allow sending cookies from another sites when doing requests other than <code class="highlighter-rouge">GET</code>.</p>

<p>Flask by default uses <code class="highlighter-rouge">session</code> cookie and its flags are set by configuring <code class="highlighter-rouge">app</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">SESSION_COOKIE_SECURE</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">SESSION_COOKIE_HTTPONLY</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">SESSION_COOKIE_SAMESITE</span><span class="o">=</span><span class="s">'Lax'</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>User defined cookies are set with response:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">'key'</span><span class="p">,</span> <span class="s">'value'</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">samesite</span><span class="o">=</span><span class="s">'Lax'</span><span class="p">)</span>
</code></pre></div></div>


  </div><a class="u-url" href="/2018/07/11/securing-flask.html" hidden></a>
</article>

      </div>
    </main></body>

</html>
