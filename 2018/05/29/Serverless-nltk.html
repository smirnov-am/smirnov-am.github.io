<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Using NLTK library with AWS Lambda. | Alexey Smirnov</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="Using NLTK library with AWS Lambda." />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’m going to walk through the process of creating a simple serverless app for finding part-of-speech tag of an input text." />
<meta property="og:description" content="I’m going to walk through the process of creating a simple serverless app for finding part-of-speech tag of an input text." />
<link rel="canonical" href="http://localhost:4000/2018/05/29/Serverless-nltk.html" />
<meta property="og:url" content="http://localhost:4000/2018/05/29/Serverless-nltk.html" />
<meta property="og:site_name" content="Alexey Smirnov" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-29T00:00:00+02:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2018/05/29/Serverless-nltk.html","description":"I’m going to walk through the process of creating a simple serverless app for finding part-of-speech tag of an input text.","headline":"Using NLTK library with AWS Lambda.","datePublished":"2018-05-29T00:00:00+02:00","dateModified":"2018-05-29T00:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/05/29/Serverless-nltk.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Alexey Smirnov" /></head>
<body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/">Alexey Smirnov</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
        <div class="trigger">
          <a class="page-link" href="https://www.linkedin.com/in/smirnovam/">Linkedin</a>
          <a class="page-link" href="https://github.com/smirnov-am">GitHub</a>
        </div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Using NLTK library with AWS Lambda.</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-05-29T00:00:00+02:00" itemprop="datePublished">May 29, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I’m going to walk through the process of creating a simple serverless app for finding part-of-speech tag of an input text.</p>

<h3 id="1-create-virtual-environment">1 Create virtual environment</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mac:serverless_nltk as<span class="nv">$ </span>mkvirtualenv nltk_env
</code></pre></div></div>

<h3 id="2-install-nltk">2 Install nltk</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span>pip <span class="nb">install </span>nltk
</code></pre></div></div>

<h3 id="3-download-nltk-data">3 Download nltk data</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span>python 
Python 3.6.2 <span class="o">(</span>v3.6.2:5fd33b5926, Jul 16 2017, 20:11:06<span class="o">)</span> 
<span class="o">[</span>GCC 4.2.1 <span class="o">(</span>Apple Inc. build 5666<span class="o">)</span> <span class="o">(</span>dot 3<span class="o">)]</span> on darwin
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> import nltk
<span class="o">&gt;&gt;&gt;</span> nltk.download<span class="o">(</span><span class="s1">'tagsets'</span><span class="o">)</span>
<span class="o">[</span>nltk_data] Downloading package tagsets to /Users/as/nltk_data...
<span class="o">[</span>nltk_data]   Unzipping <span class="nb">help</span>/tagsets.zip.
True
</code></pre></div></div>

<h3 id="4-copy-downloaded-nltk-data-to-current-directory">4 Copy downloaded nltk data to current directory</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span><span class="nb">cp</span> <span class="nt">-R</span> /Users/as/nltk_data/<span class="k">*</span> ./
</code></pre></div></div>

<h3 id="5-copy-site-packages-from-virtualenv-directory-may-be-checked-with-which-python">5 Copy site packages from virtualenv directory (may be checked with <code class="highlighter-rouge">which python</code>)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span><span class="nb">cp</span> <span class="nt">-R</span> /Users/as/.virtualenvs/nltk_env/lib/python3.6/site-packages/<span class="k">*</span> ./
</code></pre></div></div>

<h3 id="6-now-lets-create-a-lambda-function-code">6 Now let’s create a lambda function code</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="c"># since libsqlite3-dev is not installed in container running lambda</span>
<span class="c"># this workaround of creating dummy empty modules is needed</span>
<span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">"sqlite"</span><span class="p">]</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">new_module</span><span class="p">(</span><span class="s">"sqlite"</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">"sqlite3.dbapi2"</span><span class="p">]</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">new_module</span><span class="p">(</span><span class="s">"sqlite.dbapi2"</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">nltk</span>

<span class="kn">from</span> <span class="nn">nltk.data</span> <span class="kn">import</span> <span class="n">load</span>
<span class="n">tagdict</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s">'help/tagsets/upenn_tagset.pickle'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'text'</span><span class="p">)</span>
    <span class="n">tokenized</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">tagged</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">pos_tag</span><span class="p">(</span><span class="n">tokenized</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">tagdict</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tagged</span><span class="p">}</span>

</code></pre></div></div>

<h3 id="7-lets-check-the-size">7 Let’s check the size.</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span><span class="nb">du</span> <span class="nt">-sh</span> ./ | <span class="nb">cut</span> <span class="nt">-f1</span>
187M
</code></pre></div></div>

<h3 id="8-zip-everything">8 Zip everything</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span>zip <span class="nt">-r</span> <span class="nt">-9</span> <span class="nt">-q</span> ./lambda.zip <span class="k">*</span>
</code></pre></div></div>

<h3 id="9-upload-to-s3">9 Upload to S3</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span>aws s3 mb s3://serverless-nltk
<span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span>aws s3 <span class="nb">cp</span> ./lambda.zip s3://serverless-nltk
</code></pre></div></div>

<h3 id="10-create-lambda">10 Create lambda</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>nltk_env<span class="o">)</span> mac:serverless_nltk as<span class="nv">$ </span>aws lambda create-function <span class="se">\</span>
                                            <span class="nt">--function-name</span> serverless-nltk <span class="se">\</span>
                                            <span class="nt">--runtime</span>  python3.6 <span class="se">\</span>
                                            <span class="nt">--role</span> arn:aws:iam::1234567890:role/lambda_basic_execution <span class="se">\</span>
                                            <span class="nt">--handler</span> lambda_function.lambda_handler <span class="nt">--code</span> <span class="nv">S3Bucket</span><span class="o">=</span>serverless-nltk,S3Key<span class="o">=</span>lambda2.zip <span class="se">\</span>
                                            <span class="nt">--environment</span> <span class="nv">Variables</span><span class="o">={</span><span class="nv">NLTK_DATA</span><span class="o">=</span>./<span class="o">}</span> 
</code></pre></div></div>
<p>Key things here are</p>
<ul>
  <li>role arn can be found in IAM (look for role with name <code class="highlighter-rouge">lambda_basic_execution</code>)</li>
  <li>environment should create an environment variable telling nltk where look for data</li>
</ul>

<p>Now let’s create a simple javascript application that will call lambda with user input from the page:</p>
<ol>
  <li>Go to AWS Cognito</li>
  <li>Create a new identity pool</li>
  <li>In the first step check <code class="highlighter-rouge">Enable access to unauthenticated identities</code></li>
  <li>In the <code class="highlighter-rouge">sample code</code> step select javascript and copy <code class="highlighter-rouge">IdentityPoolId</code> (needed in invokation script later)</li>
  <li>Go to IAM</li>
  <li>Find the role for unauthenticated access (it will look like <code class="highlighter-rouge">Cognito_serverless_nltkUnauth_Role</code>)</li>
  <li>Select <code class="highlighter-rouge">Permission</code> and edit the role as json. It should look like this
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
     </span><span class="p">{</span><span class="w">
         </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
             </span><span class="s2">"mobileanalytics:PutEvents"</span><span class="p">,</span><span class="w">
             </span><span class="s2">"cognito-sync:*"</span><span class="w">
         </span><span class="p">],</span><span class="w">
         </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
             </span><span class="s2">"*"</span><span class="w">
         </span><span class="p">]</span><span class="w">
     </span><span class="p">},</span><span class="w">
     </span><span class="p">{</span><span class="w">
         </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
             </span><span class="s2">"lambda:InvokeFunction"</span><span class="w">
         </span><span class="p">],</span><span class="w">
         </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
             </span><span class="s2">"arn:aws:lambda:us-east-1:1234567890:function:serverless-nltk"</span><span class="w">
         </span><span class="p">]</span><span class="w">
     </span><span class="p">}</span><span class="w">
 </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ol>

<p>The script calling the lambda will look like this</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text/javascript"</span><span class="o">&gt;</span>
    <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'upload-button'</span><span class="p">);</span>
    <span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">credentials</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">CognitoIdentityCredentials</span><span class="p">({</span><span class="na">IdentityPoolId</span><span class="p">:</span> <span class="s1">'us-east-1:8b6a0b3d-6a2a-4c7d-b617-c8dafd8a1aec'</span><span class="p">});</span>
    <span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="s1">'us-east-1'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lambda</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Lambda</span><span class="p">({</span><span class="na">region</span><span class="p">:</span> <span class="s1">'us-east-1'</span><span class="p">,</span> <span class="na">apiVersion</span><span class="p">:</span> <span class="s1">'2015-03-31'</span><span class="p">});</span>
    
    <span class="kd">function</span> <span class="nx">htmlToElement</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'template'</span><span class="p">);</span>
        <span class="nx">html</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span> <span class="c1">// Never return a text node of whitespace as the result</span>
        <span class="nx">template</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">template</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kd">function</span> <span class="nx">call_lambda</span><span class="p">()</span> <span class="p">{</span> 
            <span class="kd">var</span> <span class="nx">pullParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">FunctionName</span> <span class="p">:</span> <span class="s1">'serverless-nltk'</span><span class="p">,</span>
                <span class="na">InvocationType</span> <span class="p">:</span> <span class="s1">'RequestResponse'</span><span class="p">,</span>
                <span class="na">LogType</span> <span class="p">:</span> <span class="s1">'None'</span><span class="p">,</span>
                <span class="na">Payload</span> <span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="na">text</span><span class="p">:</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"exampleFormControlTextarea1"</span><span class="p">).</span><span class="nx">value</span><span class="p">})</span>
            <span class="p">};</span>
            <span class="c1">// create variable to hold data returned by the Lambda function</span>
            <span class="kd">var</span> <span class="nx">pullResults</span><span class="p">;</span>
            <span class="nx">lambda</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">pullParams</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">pullResults</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">Payload</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pullResults</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"result"</span><span class="p">)</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">pullResults</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">htmlToElement</span><span class="p">(</span><span class="s1">'&lt;span&gt;'</span><span class="o">+</span><span class="nx">key</span><span class="o">+</span><span class="s1">':&amp;nbsp;&lt;/span&gt;'</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">htmlToElement</span><span class="p">(</span><span class="s1">'&lt;span&gt;'</span><span class="o">+</span><span class="nx">pullResults</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">+</span> <span class="s1">'&lt;/span&gt;'</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">htmlToElement</span><span class="p">(</span><span class="s1">'&lt;h6&gt;&lt;/h6&gt;'</span><span class="p">);</span>
                    <span class="nx">line</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
                    <span class="nx">line</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
                    <span class="nx">result</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="p">});</span>
    <span class="p">};</span> 
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>The resulting app can be accessed <a href="http://serverless-nltk.s3-website-us-east-1.amazonaws.com/">here</a></p>


  </div><a class="u-url" href="/2018/05/29/Serverless-nltk.html" hidden></a>
</article>

      </div>
    </main></body>

</html>
