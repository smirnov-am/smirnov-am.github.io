<!DOCTYPE html>
<html âš¡>
<head>
    <meta charset="utf-8">

    <title>Securing Flask web applications</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="canonical" href="http://localhost:2368/securing-flask-web-applications/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="smirnov-am.github.io" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Securing Flask web applications" />
    <meta property="og:description" content="I&#x27;ve just recently finished a web security training and in this post I&#x27;d like to
investigate security mechanisms of my beloved web framework - Flask.
I&#x27;ll go through different types of possible vulnerabilities and the way they can
be mitigated.

XSS
Cross-Site Scripting (XSS) attacks are a type of injection, in which malicious
scripts are injected into otherwise benign and trusted websites. source
[https://www.owasp.org/index.php/Cross-site_Scripting_%28XSS%29]

Exploit
Consider a form asking fo" />
    <meta property="og:url" content="http://localhost:2368/securing-flask-web-applications/" />
    <meta property="og:image" content="http://localhost:2368/content/images/2019/04/flask11.jpg" />
    <meta property="article:published_time" content="2018-07-11T17:26:00.000Z" />
    <meta property="article:modified_time" content="2019-04-27T17:30:43.000Z" />
    <meta property="article:tag" content="python" />
    <meta property="article:tag" content="Flask" />
    <meta property="article:tag" content="Security" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Securing Flask web applications" />
    <meta name="twitter:description" content="I&#x27;ve just recently finished a web security training and in this post I&#x27;d like to
investigate security mechanisms of my beloved web framework - Flask.
I&#x27;ll go through different types of possible vulnerabilities and the way they can
be mitigated.

XSS
Cross-Site Scripting (XSS) attacks are a type of injection, in which malicious
scripts are injected into otherwise benign and trusted websites. source
[https://www.owasp.org/index.php/Cross-site_Scripting_%28XSS%29]

Exploit
Consider a form asking fo" />
    <meta name="twitter:url" content="http://localhost:2368/securing-flask-web-applications/" />
    <meta name="twitter:image" content="http://localhost:2368/content/images/2019/04/flask11.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Alexey Smirnov" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="python, Flask, Security" />
    <meta property="og:image:width" content="1280" />
    <meta property="og:image:height" content="720" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "smirnov-am.github.io",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/favicon.ico",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Alexey Smirnov",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/f3f61e69a3bdf7419f19cb1be356c0b1?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/alexey/",
        "sameAs": []
    },
    "headline": "Securing Flask web applications",
    "url": "http://localhost:2368/securing-flask-web-applications/",
    "datePublished": "2018-07-11T17:26:00.000Z",
    "dateModified": "2019-04-27T17:30:43.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "http://localhost:2368/content/images/2019/04/flask11.jpg",
        "width": 1280,
        "height": 720
    },
    "keywords": "python, Flask, Security",
    "description": "I&#x27;ve just recently finished a web security training and in this post I&#x27;d like to\ninvestigate security mechanisms of my beloved web framework - Flask.\nI&#x27;ll go through different types of possible vulnerabilities and the way they can\nbe mitigated.\n\nXSS\nCross-Site Scripting (XSS) attacks are a type of injection, in which malicious\nscripts are injected into otherwise benign and trusted websites. source\n[https://www.owasp.org/index.php/Cross-site_Scripting_%28XSS%29]\n\nExploit\nConsider a form asking fo",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.21" />
    <link rel="alternate" type="application/rss+xml" title="smirnov-am.github.io" href="http://localhost:2368/rss/" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="http://localhost:2368">smirnov-am.github.io</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Securing Flask web applications</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/alexey/">Alexey Smirnov</a></p>
                    <time class="post-date" datetime="2018-07-11">2018-07-11</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="http://localhost:2368/content/images/2019/04/flask11.jpg" width="600" height="400" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <p>I've just recently finished a web security training and in this post I'd like to investigate security mechanisms of my beloved web framework - Flask.<br />I'll go through different types of possible vulnerabilities and the way they can be mitigated.</p><h2 id="xss">XSS</h2><p>Cross-Site Scripting (XSS) attacks are a type of injection, in which malicious scripts are injected into otherwise benign and trusted websites. <a href="https://www.owasp.org/index.php/Cross-site_Scripting_%28XSS%29">source</a></p><h3 id="exploit">Exploit</h3><p>Consider a form asking for a user input.</p><pre><code>&lt;form method="post" action="/"&gt;
  &lt;input type="text" name="tweet"&gt;&lt;br&gt;
  &lt;input type="submit"&gt;
&lt;/form&gt;
</code></pre><p>And a template to show tweets by other users where user input from above form passed unprocessed:</p><pre><code>&lt;title&gt;Hello from flask twitter&lt;/title&gt;
{% for tweet in tweets %}
  &lt;h1 class={{tweet}}&gt;{{ tweet }}!&lt;/h1&gt;
  &lt;a href="{{tweet}}"&gt;Like&lt;/a&gt;
{% endfor %}
</code></pre><p>With the Flask app looking like this:</p><pre><code>from flask import Flask, request, render_template, make_response
app = Flask(__name__)

tweets = []


@app.route('/', methods=['GET', 'POST'])
def tweet_feed():
    if request.method == 'POST':
        tweet = request.form['tweet']
        tweets.append(tweet)
    return render_template('tweet_feed.html', tweets=tweets)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5005, debug=True)
</code></pre><p>The tweet posted by user will be used as <code>h1</code> class attribute and inside the tag and also as <code>a</code> href attribute.</p><p>A hacker may post malicious code and when another users will open the page with tweets that code may be executed by their browsers:</p><ol><li><code>" onload=alert(1)</code> - if this appears in class attribute it will close the double quote and add a callback to onload event for this DOM.</li><li><code>javascript:alert(1);</code> - if this javascript URI appears in href attribute, browser will execute a code when user clicks.</li><li><code>&lt;script&gt;alert(1)&lt;/script&gt;</code> - if this appears anywhere on the page the script will be executed.</li></ol><p>The script may not just show an alert message, but for example do an AJAX call to another endpoint on this site (i.e. password change). Â This allows the attacker to perform any action as the user on this website.</p><h3 id="mitigation">Mitigation</h3><p>When rendering templates Flask configures Jinja2 to automatically escape all values unless explicitly told otherwise. Auto-escaping is not enabled for all templates.<br />The following extensions for templates trigger auto-escaping: .html, .htm, .xml, .xhtml. Templates loaded from a string will have auto-escaping disabled.</p><p>So because of the above exploit using code #3 will be escaped and never executed.</p><p>Code #1 gives me <code>ERR_BLOCKED_BY_XSS_AUDITOR</code> error in Chrome Version 65.0.3325.181. This browser behavior can be manipulated by the server with <code>X-XSS-Protection</code> header <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection">source</a></p><p>The only vulnerable part is href attribute in <code>a</code> tag.<br />We have a following option to mitigate</p><ul><li>do not use user input with <code>href</code></li><li>use <code>{{ url_for('endpoint')}}</code> when rendering template. This has additional benefit of automatically building proper URLs if endpoint path changes.</li><li>use Â <code>Content-Security-Policy</code> header in response:</li></ul><pre><code>@app.route('/', methods=['GET', 'POST'])
def tweet_feed():
    if request.method == 'POST':
        tweet = request.form['tweet']
        tweets.append(tweet)
    response = make_response(render_template('tweet_feed.html', tweets=tweets))
    response.headers['Content-Security-Policy'] = "default-src 'self'"
    return response
</code></pre><p>Content Security Policy (CSP) is security mechanism aimed at protecting from XSS and Clickjacking attacks. CSP allows you to specify trusted origins of loading resources such as Javascript, fonts, CSS and others. And also ban the execution of the built-in Javascript code. <a href="https://web-security.guru/en/web-security/content-security-policy">source</a></p><p><code>default-src 'self'</code> in <code>Content-Security-Policy</code> header in server response instructs browser to load and execute scripts from the same source - your server, which is identified by protocol (http/https), hostname and port triplet. It also disables inline scripts like the one from malicious code #3.</p><p>Another types of XSS are the ones where malicious code is embedded in uploaded file (text, images). I'll address them in File upload section later</p><h2 id="csrf">CSRF</h2><p>Cross-Site Request Forgery is an attack that allows an attacker to make requests to various sites under victim user. If the victim comes to a site containing a malicious code, a request is sent from her username to another service (social network) performing a destructive action.<br />Unlike XSS the malicious code is stored on hacker controlled server where user is tricked to visit.</p><h2 id="exploit-1">Exploit</h2><p>Consider a online bank transfer page. You may access it by logging beforehand with the authentication information stored in cookie files.</p><pre><code>&lt;!doctype html&gt;
&lt;title&gt;Hello from Flask&lt;/title&gt;
&lt;h1&gt;Account balance {% raw %}${{ balance }}{% endraw %}&lt;/h1&gt;

&lt;h2&gt;New transfer&lt;/h2&gt;
&lt;form method="post" action="/"&gt;
  &lt;input type="text" name="destination_account" placeholder="Destination account"&gt;&lt;br&gt;
  &lt;input type="number" name="amount"&gt;&lt;br&gt;
  &lt;input type="submit" value="Transfer"&gt;
&lt;/form&gt;
</code></pre><p>With Flaks app looking like this:</p><pre><code>from flask import Flask, request, render_template
app = Flask(__name__)

account_balance = 1000


@app.route('/', methods=['GET', 'POST'])
def transfer():
    global account_balance
    if request.method == 'POST':
        transferred_amount = request.form['amount']
        if transferred_amount.isdigit():
            account_balance -= int(transferred_amount)
    response = make_response(render_template('transfer.html', balance=account_balance))
    return response


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5005, debug=True)
</code></pre><p>Now an attacker may trick you to follow a link to his website (I'm getting a lot of 'Your transaction is approved, Follow this link for details' spam messages recently).<br />When you follow the link a page with the following script loads:</p><pre><code>&lt;form method="POST" action="http://0.0.0.0:5005/" id="hacker_form"&gt;
   &lt;input type="text" name="destination_account" value="123123123"/&gt;
   &lt;input type="number" name="amount" value="1000"/&gt;
   &lt;input type="submit" value="Transfer"&gt;
&lt;/form&gt;
&lt;script&gt;document.getElementById("hacker_form").submit()&lt;/script&gt;
</code></pre><p>So when sending this form to bank app at <a href="http://0.0.0.0:5005/">http://0.0.0.0:5005/</a> authorization cookie will be also sent along. Thus user authorized bank to transfer $10000 to Account #123123123</p><h3 id="mitigation-1">Mitigation</h3><p>I've used endpoint that changes the state of account only on POST request. That complicated hacker's task a little bit as he needs user to visit his server with malicious code.<br />If it was just GET user only needs to click the link without loading the script from hacker's server.</p><p>Another security measure is to use tokens with each account state change endpoint.<br />With every form user gets a random token (as a form's hidden field) and when form is POSTed, the token is checked for validity and expiration.<br />In Flask this is implemented in <a href="http://flask-wtf.readthedocs.io/en/stable/">Flask-WTF plugin</a></p><p>Outline</p><ol><li>GET requests should not change the state of the system</li><li>Check <code>Origin</code> and/or <code>Referer</code> request header in server code to match real server name</li><li>Use CSRF-tokens</li></ol><h2 id="sql-injection">SQL Injection</h2><p>SQL Injection occurs when attacker-controlled input is inserted into a SQL query without proper validation or sanitization. This often occurs when using string formatting or concatenation to build queries.<br />An attacker may be able to read data for which they are not authorized, tamper with or destroy data, or possibly even write files or execute code on the database server. The impact is dependent on the exact scenario, but is generally quite severe.</p><h3 id="exploit-2">Exploit</h3><p>Consider bank transfer form from the above example with the following Flask app (I'm using SQLAlchemy here and trying to put things simple, but usually it's not how you manage database session in Flask app)</p><pre><code>from flask import Flask, request, render_template, make_response, redirect, url_for
from sqlalchemy import Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy import create_engine

app = Flask(__name__)
Base = declarative_base()
engine = create_engine('sqlite:///123.db', echo=True)

@app.route('/', methods=['GET', 'POST'])
def transfer():
    session = sessionmaker(bind=engine)()
    account_balance_query = session.execute('SELECT balance from accounts WHERE number=1111')
    account_balance = int(account_balance_query.fetchone()[0])
    if request.method == 'POST':
        transferred_amount = request.form['amount']
        destination_account = request.form['destination_account']
        session.execute('UPDATE accounts SET balance = balance - ' + transferred_amount + ' WHERE number=1111')
        session.execute('UPDATE accounts SET balance = balance + ' + transferred_amount + ' WHERE number=' + destination_account)
        session.commit()
        session.close()
        return redirect(url_for('transfer'))
    response = make_response(render_template('transfer.html', balance=account_balance))
    session.close()
    return response

</code></pre><p>I've tried to break all the rules here: building raw queries and concatenating query string with user input directly (I might have used <code>.format</code> as well).<br />So when entering <code>2222;DROP DATABASE;</code> in destination account input field I expected this particular line<br /><code>session.execute('UPDATE accounts SET balance = balance + ' + transferred_amount + ' WHERE number=' + destination_account)</code><br />execute an update and then drop database.<br />But it gave me that error <code>sqlite3.Warning: You can only execute one statement at a time.</code> and no changes were made to database.<br />Not all drivers have that protection, while <a href="http://dev.mysql.com/doc/connector-python/en/connector-python-api-mysqlcursor-execute.html">some</a> allow multiple statement to be executed like so.</p><h3 id="mitigation-2">Mitigation</h3><p>The proper way to avoid that is to use ORMs. In that case the Flask app will be like this:</p><pre><code>from flask import Flask, request, render_template, make_response, redirect, url_for
from sqlalchemy import Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy import create_engine

app = Flask(__name__)
Base = declarative_base()
engine = create_engine('sqlite:///123.db', echo=True)


class Account(Base):
    __tablename__ = 'accounts'
    id = Column(Integer, primary_key=True, autoincrement=True)
    number = Column(String(64))
    balance = Column(Integer)


@app.route('/', methods=['GET', 'POST'])
def transfer():
    session = sessionmaker(bind=engine)()
    account = session.query(Account).filter_by(number='1111').one()
    if request.method == 'POST':
        transferred_amount = int(request.form['amount'])
        account.balance -= transferred_amount
        destination_account_number = request.form['destination_account']
        destination_account = session.query(Account).filter_by(number=destination_account_number).one()
        destination_account.balance += transferred_amount
        session.commit()
        session.close()
        return redirect(url_for('transfer'))
    session.close()
    response = make_response(render_template('transfer.html', balance=account.balance))
    return response
</code></pre><h2 id="directory-traversal">Directory traversal</h2><p>Directory traversal may happen when for example an attacker uploads a file with a filename like <code>../../../etc/passwd</code>. If he guessed the number of <code>..</code> right he might overwrite the file (given that uwsgi or Flask is running as root, but it may be any other file like <code>~/bash.rc</code>).<br />The mitigation is explained in official Flask docs <a href="http://flask.pocoo.org/docs/1.0/patterns/fileuploads/">here</a></p><p>Essentially you need to sanitize filenames from file upload form. Another advice is avoid using user provided filenames at all and generate your own (hash of the datetime/username/etc) and store them on a separate subdomain (more on it later)</p><h2 id="xss-in-uploaded-files">XSS in uploaded files</h2><p>This is not particularly related to Flask, but malicious javascript might appear not only in reflected output or stored in database (see general XSS attack), but it can also be embedded in images.<br />For example, <a href="https://marcoramilli.blogspot.com/2014/01/hacking-through-image-gif-turn.html">this blog post</a><br />uses that <a href="https://pastebin.com/6yUbfGX5">code</a> to embed javascript in GIF image file. CSP won't help here - so the only way is to serve the images from separate subdomain (that's what actually Facebook does)</p><p>Another thing related to files is how to you actually serve them. A pdf document uploaded by an attacker may have malicious code so if that file is server to another users it's better to add <code>Content-Disposition: attachment</code> header to server response so browser will download it instead of showing right away.</p><h2 id="cookie-protection">Cookie protection</h2><p>Cookie files are used for a lot of things along with storing session or authentication data.<br />There are some methods to protect them from exposing to an attacker</p><h3 id="secure">Secure</h3><p>Cookies are sent with every request in clear text:</p><pre><code>GET /index.html HTTP/1.1
Host: www.example.org
Cookie: session=XXXXXXX
</code></pre><p>It means that if an attacker that controls network equipment between you and server (or your ISP) can easily read it.<br />Setting cookie <code>secure</code> flag will instruct browser to send a cookie only over protected HTTPS connection.</p><h3 id="http-only">HTTP Only</h3><p><code>HttpOnly</code> flag will instruct browser to hide cookie content from javascript code. In case of XSS attack it will prevent an attacker from accessing sensitive data stored in it.</p><h3 id="samesite">SameSite</h3><p>In the CSRF example the critical part of the attack was that user's cookie was send from attacker controlled site. It can be mitigated by setting <code>SameSite=strict</code>.<br />Another option for that flag is 'lax' which won't allow sending cookies from another sites when doing requests other than <code>GET</code>.</p><p>Flask by default uses <code>session</code> cookie and its flags are set by configuring <code>app</code>:</p><pre><code>app.config.update(
    SESSION_COOKIE_SECURE=True,
    SESSION_COOKIE_HTTPONLY=True,
    SESSION_COOKIE_SAMESITE='Lax',
)
</code></pre><p>User defined cookies are set with response:</p><pre><code>response.set_cookie('key', 'value', secure=True, httponly=True, samesite='Lax')
</code></pre><p>Have your Flask apps ever been hacked? Drop me a message on LinkedIn <a href="https://www.linkedin.com/in/smirnovam/">https://www.linkedin.com/in/smirnovam/</a></p>

            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="http://localhost:2368">smirnov-am.github.io</a> &copy; 2019</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
